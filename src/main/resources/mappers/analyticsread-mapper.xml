<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fury.deep.project_builder.repository.analytics.AnalyticsReadMapper">
    <select id="findDashboard" resultMap="AnalyticsResultMap.dashboardMap">

        SELECT
            -- Project Health
            ph.health_score             AS healthScore,
            ph.overdue_tasks            AS overdueTasks,
            ph.blocked_tasks            AS blockedTasks,
            ph.risk_level               AS riskLevel,

            -- Flow
            pf.wip_count                AS wipCount,
            pf.throughput_7d            AS throughput7d,
            pf.throughput_30d           AS throughput30d,
            pf.avg_cycle_time_days      AS avgCycleTime,
            pf.reopened_tasks           AS reopenedTasks,

            -- Dependency
            dr.total_dependencies       AS totalDependencies,
            dr.blocked_dependency_count AS blockedDependencyCount,
            dr.critical_path_length     AS criticalPathLength,
            dr.dependency_density       AS dependencyDensity,
            dr.risk_score               AS dependencyRiskScore,

            -- Team
            tc.active_projects          AS activeProjects,
            tc.active_tasks             AS activeTasks,
            tc.avg_tasks_per_user       AS avgTasksPerUser,
            tc.overloaded_users         AS overloadedUsers,
            tc.avg_completion_time_days AS avgCompletionTimeDays,
            tc.burnout_risk_score       AS burnoutRiskScore

        FROM project p

                 LEFT JOIN project_health ph
                           ON ph.project_id = p.id

                 LEFT JOIN project_flow_metrics pf
                           ON pf.project_id = p.id

                 LEFT JOIN project_dependency_risk dr
                           ON dr.project_id = p.id

                 LEFT JOIN team_capacity_analytics tc
                           ON tc.team_id = p.team_id

        WHERE p.id = #{projectId}

    </select>
</mapper>
