<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fury.deep.project_builder.repository.analytics.AnalyticsReadMapper">

    <!-- PROJECT HEALTH -->
    <select id="findProjectHealth"
            resultType="fury.deep.project_builder.dto.analytics.ProjectHealthDto">
        SELECT health_score           AS healthScore,
               schedule_variance_days AS scheduleVarianceDays,
               progress_variance_pct  AS progressVariancePct,
               overdue_tasks          AS overdueTasks,
               blocked_tasks          AS blockedTasks,
               risk_level             AS riskLevel
        FROM project_health
        WHERE project_id = #{projectId}
    </select>

    <!-- FLOW -->
    <select id="findProjectFlow"
            resultType="fury.deep.project_builder.dto.analytics.ProjectFlowDto">
        SELECT wip_count      AS wipCount,
               throughput_7d  AS throughput7d,
               throughput_30d AS throughput30d,
               avg_cycle_time AS avgCycleTime,
               reopened_tasks AS reopenedTasks
        FROM project_flow_metrics
        WHERE project_id = #{projectId}
    </select>

    <!-- DEPENDENCY -->
    <select id="findDependencyRisk"
            resultType="fury.deep.project_builder.dto.analytics.DependencyRiskDto">
        SELECT total_dependencies       AS totalDependencies,
               blocked_dependency_count AS blockedDependencyCount,
               critical_path_length     AS criticalPathLength,
               dependency_density       AS dependencyDensity,
               risk_score               AS riskScore
        FROM project_dependency_risk
        WHERE project_id = #{projectId}
    </select>

    <!-- TEAM -->
    <select id="findTeamCapacity"
            resultType="fury.deep.project_builder.dto.analytics.TeamCapacityDto">
        SELECT active_projects          AS activeProjects,
               active_tasks             AS activeTasks,
               avg_tasks_per_user       AS avgTasksPerUser,
               overloaded_users         AS overloadedUsers,
               avg_completion_time_days AS avgCompletionTimeDays,
               burnout_risk_score       AS burnoutRiskScore
        FROM team_capacity_analytics
        WHERE team_id = (
            SELECT team_id
            FROM project
            WHERE id = #{projectId}
        )
    </select>

</mapper>
