<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fury.deep.project_builder.repository.task.TaskMapper">

    <insert id="insertTask" useGeneratedKeys="true" keyProperty="task.id">
        INSERT INTO task
        (name, project_id, feature_id, priority, status, start_date, end_date, started_at, completed_at, updated_by,
         updated_at)
        VALUES (#{task.name},
                #{task.projectId},
                #{task.feature.id},
                #{task.priority},
                #{task.status},
                #{task.start},
                #{task.end},
                #{task.startedAt},
                #{task.completedAt},
                #{task.updatedBy},
                #{task.updatedAt})
    </insert>

    <update id="updateTask">
        UPDATE task
        SET name         = #{task.name},
            feature_id   = #{task.feature.id},
            priority     = #{task.priority},
            status       = #{task.status},
            start_date   = #{task.start},
            end_date     = #{task.end},
            started_at   = #{task.startedAt},
            completed_at = #{task.completedAt},
            updated_by   = #{task.updatedBy},
            updated_at   = #{task.updatedAt}
        WHERE id = #{task.id}
    </update>

    <delete id="deleteTask">
        DELETE
        FROM task
        WHERE id = #{taskId}
    </delete>

    <select id="findTaskById" resultMap="TaskResultMap.taskFullMap">
        SELECT t.id   AS task_id,
               t.project_id,
               t.name AS task_name,
               t.priority,
               t.status,
               t.start_date,
               t.end_date,
               t.updated_by,
               t.updated_at,
               t.started_at,
               t.completed_at,
               f.id   AS feature_id,
               f.name AS feature_name
        FROM task t
                 LEFT JOIN feature f ON f.id = t.feature_id
        WHERE t.id = #{taskId}
    </select>

    <select id="findAssigneesByTaskId" resultType="string">
        SELECT user_id
        FROM task_assignee
        WHERE task_id = #{taskId}
    </select>

    <select id="findDependenciesByTaskId" resultType="string">
        SELECT depends_on_task_id
        FROM task_dependency
        WHERE task_id = #{taskId}
    </select>

    <select id="findTasksByUserId" resultMap="TaskResultMap.taskWithAssigneesMap">
        SELECT t.id   AS task_id,
               t.project_id,
               t.name AS task_name,
               t.priority,
               t.status,
               t.start_date,
               t.end_date,
               t.updated_by,
               t.updated_at,
               t.started_at,
               t.completed_at,

               f.id   AS feature_id,
               f.name AS feature_name,

               ta.user_id
        FROM task t
                 JOIN task_assignee ta ON ta.task_id = t.id
                 LEFT JOIN feature f ON f.id = t.feature_id
        WHERE ta.user_id = #{userId}
    </select>

    <select id="findTasksByProjectId"
            resultMap="TaskResultMap.taskProjectViewMap"
            resultOrdered="true">

        SELECT t.id     AS task_id,
               t.name   AS task_name,
               t.status AS status,
               td.depends_on_task_id
        FROM task t
                 LEFT JOIN task_dependency td ON td.task_id = t.id
        WHERE t.project_id = #{projectId}
        ORDER BY t.id
    </select>

    <!-- Find tasks that depend on a given task -->
    <select id="findTasksDependingOn" resultMap="TaskResultMap.taskFullMap">
        SELECT t.id   AS task_id,
               t.project_id,
               t.name AS task_name,
               t.priority,
               t.status,
               t.start_date,
               t.end_date,
               t.updated_by,
               t.updated_at,
               t.started_at,
               t.completed_at,
               f.id   AS feature_id,
               f.name AS feature_name
        FROM task t
                 LEFT JOIN feature f ON f.id = t.feature_id
                 JOIN task_dependency td ON td.task_id = t.id
        WHERE td.depends_on_task_id = #{taskId}
    </select>

    <!-- Count how many of a list of tasks are COMPLETED -->
    <select id="countCompletedTasks" resultType="int">
        SELECT COUNT(*) FROM task
        WHERE status = 'COMPLETED'
        AND id IN
        <foreach collection="taskIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="countTasksInProject" resultType="int">
        SELECT COUNT(*)
        FROM "task" t
        WHERE t.project_id = #{projectId}
        AND t.id IN
        <foreach collection="tasks"
                 item="task"
                 open="("
                 separator=","
                 close=")">
            #{task}
        </foreach>
    </select>
</mapper>